---
title: 'Handling missing data'
teaching: 10
exercises: 2
---

:::::::::::::::::::::::::::::::::::::: questions 

- How do you write a lesson using R Markdown and `{sandpaper}`?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Explain how to use markdown with the new lesson template
- Demonstrate how to include pieces of code, figures, and nested challenge blocks

::::::::::::::::::::::::::::::::::::::::::::::::
```{r}
library(dlookr)
```



Missing data happens. And they happen for different reasons. 

* data der skulle have v√¶ret der. Men ikke er der alligevel.
* Data der ikke skulle have v√¶ret der.

tekniske fejl - data der blev m√•lt. Men ikke gemt. Eler hvis et m√•le instrument
fejlede, s√• eksempelvis temperaturen ikke blev m√•lt.

I sp√∏rgeskemaer - hvis respondenten n√¶gter at svare

Ikke relevant. Hvis respondenten ikke har b√∏rn - s√• er der ofte en r√¶kke sp√∏rgsm√•l der
med god grund mangler.

Drop-ud eller frafald. I l√¶ngerevarende unders√∏gelser kan nogen af respondenterne
falde ud af undersg√∏elsen over tid. Eller i l√¶ngere sp√∏rgeskemaer, kan respondenter
give op undervejs.

Manglende match mellem indsamlingspraksis. Forskellige interviewere registrerer 
forskelligt.

Der kan v√¶re forskellige mekanismer, som er relevante.

MCAR - Missing Completely At Random. Data mangler tilf√¶ldigt, uafh√¶ngigt af 
√∏vrige data. 

MAR - Missing At Random. Mangler afh√¶ngig af observerede variable. Mangleheden, 
eller hvad vi nu skal kalde det - afh√¶nger af variablen. Eg at vi mangler 
BMI-v√¶rdier for kvinder. Men vi har registeret deres k√∏n.

MNAR - Missing Not At Random. Manglen afh√¶nger af v√¶rdien selv, eller noget andet
som vi ikke ved hvad er. Folk med h√∏jt alkoholforbrug oplyser eksempelvis ofte at 
oplyse herom.

DU M√Ö ALDRIG ANTAGE AT DATA MANGLER TILF√ÜLDIGT. Du skal forst√• hvorfor noget mangler,
f√∏r du beslutter hvordan du h√•ndterer det. Hvis din antagelse om mekanismen (MCAR, MAR, MNAR),
er forkert, kan det sk√¶vvride hele analysen.


MCAR er den enkleste tilgang. Vi foretager "listwise deletion". Hvilket bare
er en fancy m√•de at sige at vi sletter de observationer hvor data mangler. 
Vi sender sp√∏rgeskemaer ud. og ikke alle svarer.
Dem sletter vi. Nogen svarer ikke p√• alle sp√∏rgsm√•l. Dem sletter vi ogs√•.
Vi kunne ogs√• kalde det for "complete case analysis" - vi analyserer kun
p√• de komplette cases.

Hvordan sikrer vi os at det faktisk er MCAR. Det er der en test for. Little's 
test hedder den.

```{r}
library(naniar)
```


Vi bliver ofte kede af at sltte observationer - for s√• mange data har vi sj√¶ldent.
Men listwise deletion er nok det mest sikre s√•dan statistisk, n√•r m√¶ngden af 
manglende data er lille (<5-10%)

Hvis vi vil bevare statistisk styrke, holde m√¶ngden af observationer, foretager vi
imputation.
Brug imputation hvis:
Du har mange NA'er og ikke vil miste observationsr√¶kker
Du laver modeller, der er f√∏lsomme over for sample size (fx GLMs)
Du skal tr√¶ne maskinl√¶ringsmodeller (de fleste kr√¶ver komplette data)

undlad imputering hvis:
Der kun mangler f√• v√¶rdier
Du laver deskriptiv statistik, og vil holde alt transparent
Du ikke vil introducere nogen som helst antagelser

MAR er mere komplekst. Her kan vi med fordel imputere data. 

MNAR - her er der ingen gode l√∏sninger. Overvej at antage forskellige scenarier.
du kan eksempelvis imputere lav, h√∏j eller gennemsnitlig v√¶rdig og sammenligene
resultaterne.

Du kan og√• imputere baseret p√• din faglige viden eksempelvis "vi ved fra tidligere
studier at folk med lav score typisk ikke svarer". og baseret p√• det imputere lave
v√¶rider (eller h√∏je, hvis det normalt er dem der ikke svarer)




```{r}
install.packages("naniar")
library(naniar)

# Test om missingness er MCAR
naniar::test
```

og littles test har null-hypotesen at data er MCAR. S√• hvis p-v√¶rdien er 
mindre end 0.05 kan vi afvise null-hypotesen. Og det er ikke det vi er 
ude efter. 

 p > 0,05, vi kan ikke afvise, at data er MCAR (alts√•: de kan v√¶re MCAR)

Hvis p < 0,05, er der systematik i missingness ‚Üí ikke MCAR ‚Üí muligvis MAR eller MNAR
bem√¶rk at det er omvendt af hvad vi plejer at se. Normalt vil vi gerne se en
lav p-v√¶rdi, fordi vi s√• kan afvise null-hypotesen, der som regel er at "der er ikke
noget sp√¶ndende her". Her vil vi gerne se en h√∏j p-v√¶rdi, fordi vi s√• ikke kan
afvise null-hypotesen, der her er "det er den lette udgave af problemet".



## noter om bwplot

When performing multiple imputation of missing data, it is essential to evaluate how the imputed values compare to the observed data. The bwplot() function of the mice package in R offers a straightforward way to visualize and assess these relationships using boxplots.
The attached image, created with the bwplot() function, showcases how the distributions of observed and imputed values vary across different imputations for multiple variables. Here's what the plot reveals!
üîπ Plot Explained: The plot compares the distributions of observed (blue boxplots, labeled "0") and imputed values (pink boxplots, labeled "1" to "5") for each variable across five imputations.
üîπ Observed vs. Imputed Data: For variables such as wgt and bmi, the imputed values closely align with the observed data, indicating that the imputation model effectively captures the underlying structure of the data. However, differences between observed and imputed distributions do not necessarily signify an issue. They may reflect systematic patterns in the missing data that are accurately modeled by the imputation algorithm.
üîπ Imputation Consistency: Stable distributions across imputations demonstrate consistency and reliability in the imputation process. If variability persists between imputations, it may indicate the need for further iterations or adjustments to the imputation model.
To generate this plot using the mice package in R:
library(mice)
my_imp <- mice(boys)
bwplot(my_imp)


::::::::::::::::::::::::::::::::::::: keypoints 

- Use `.md` files for episodes when you want static content
- Use `.Rmd` files for episodes when you need to generate output
- Run `sandpaper::check_lesson()` to identify any issues with your lesson
- Run `sandpaper::build_lesson()` to preview your lesson locally

::::::::::::::::::::::::::::::::::::::::::::::::

